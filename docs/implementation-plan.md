# AI 音乐陪练系统 — 实施计划

> 状态标记：⬜ 待完成 | 🔄 进行中 | ✅ 已完成

---

## 阶段一：项目基础设施（Foundation）

### 1.1 项目初始化

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 1.1.1 | Vite + React 18 + TypeScript 项目脚手架 | ✅ | `npm create vite@latest`，配置 tsconfig、ESLint、Prettier |
| 1.1.2 | Tailwind CSS 集成 | ✅ | Tailwind v4 + Vite 插件，定义设计系统色板 |
| 1.1.3 | shadcn/ui 初始化 | ✅ | shadcn/ui init + 8 个基础组件（Button、Card、Dialog、DropdownMenu、Progress、Slider、Tabs、Tooltip） |
| 1.1.4 | React Router v6 路由配置 | ✅ | 配置 8 个页面路由，lazy 加载 + 代码分割 |
| 1.1.5 | 布局组件搭建 | ✅ | MainLayout（侧边栏+内容区）、MobileLayout、Sidebar 导航 |
| 1.1.6 | FontAwesome + Lucide Icons 集成 | ✅ | lucide-react + @fortawesome/fontawesome-free 安装完成 |

### 1.2 状态管理与数据层

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 1.2.1 | Zustand Store 架构搭建 | ✅ | useAppStore、usePracticeStore、useAudioStore、useScoreStore |
| 1.2.2 | sql.js (SQLite WASM) 初始化 | ✅ | 数据库初始化、WASM 加载、IndexedDB 持久化 |
| 1.2.3 | 数据库 Schema 建表 | ✅ | 7 张表 + 索引，schema.sql + 自动初始化 |
| 1.2.4 | Repository 数据访问层 | ✅ | UserRepository、PracticeRepository、ScoreRepository、AchievementRepository |
| 1.2.5 | 数据库迁移机制 | ✅ | 版本管理，schema_migrations 表跟踪，支持后续升级 |

### 1.3 国际化与基础工具

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 1.3.1 | react-i18next 配置 | ✅ | i18n 初始化，浏览器语言自动检测，手动切换 |
| 1.3.2 | 英文翻译文件 (en.json) | ✅ | 所有 UI 文案英文版 |
| 1.3.3 | 中文翻译文件 (zh.json) | ✅ | 所有 UI 文案中文版 |
| 1.3.4 | TypeScript 类型定义 | ✅ | music.ts、scoring.ts、database.ts、instrument.ts 类型文件 |
| 1.3.5 | 音乐理论工具函数 | ✅ | 频率↔音名转换、音分计算、MIDI 编号映射等 |

---

## 阶段二：乐器抽象与曲库系统

### 2.1 乐器抽象层

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 2.1.1 | Instrument 接口定义 | ✅ | 定义乐器基类接口：音域、调音标准、检测策略、评分参数 |
| 2.1.2 | Piano 钢琴实现 | ✅ | 钢琴特有参数：88 键音域、多声部、左右手声部 |
| 2.1.3 | Cello 大提琴实现 | ✅ | 大提琴特有参数：四弦音域、连续音高、弓法标记 |
| 2.1.4 | InstrumentFactory 工厂 | ✅ | 乐器实例创建工厂，支持未来扩展 |

### 2.2 曲库系统

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 2.2.1 | MusicXML 解析器 (ScoreParser) | ✅ | 解析 MusicXML 为内部数据结构（音符、小节、声部、标记） |
| 2.2.2 | 难度自动计算器 (DifficultyCalculator) | ✅ | 基于音符密度、音域范围、节奏复杂度计算难度等级 |
| 2.2.3 | 钢琴内置曲库准备 | ✅ | 收集 ≥20 首公版钢琴 MusicXML + MIDI（初/中/高级） |
| 2.2.4 | 大提琴内置曲库准备 | ✅ | 收集 ≥15 首公版大提琴 MusicXML + MIDI（初/中/高级） |
| 2.2.5 | 曲库数据入库 | ✅ | 曲目元信息写入 tracks 表，资源文件打包到 assets/ |
| 2.2.6 | 用户自定义乐谱上传 | ✅ | MusicXML 上传、解析验证、存储到 IndexedDB、自动计算难度 |

---

## 阶段三：音频引擎（Audio Engine）

### 3.1 音频采集与预处理

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 3.1.1 | AudioCapture 麦克风采集 | ✅ | Web Audio API 麦克风权限请求、音频流管理、采样率配置 |
| 3.1.2 | NoiseFilter 噪声过滤 | ✅ | 基本环境噪声过滤、自动增益控制 |
| 3.1.3 | AudioWorklet 处理器 | ✅ | pitch-processor、onset-processor 工作线程 |
| 3.1.4 | 音频文件上传解析 | ✅ | 支持 WAV/MP3/M4A/FLAC 解码为 AudioBuffer |

### 3.2 音高检测

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 3.2.1 | MonoPitchDetector 单音检测 | ✅ | 基于 Pitchy 的实时基频检测，大提琴音分级精度 |
| 3.2.2 | Essentia.js WASM 集成 | ✅ | 实时 chroma 特征提取，用于乐谱跟随 |
| 3.2.3 | PolyPitchDetector 多音检测 | ✅ | 基于 @spotify/basic-pitch-ts 的钢琴多声部识别 |
| 3.2.4 | PitchDetector 调度器 | ✅ | 根据乐器类型自动选择单音/多音检测策略 |

### 3.3 节奏与速度检测

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 3.3.1 | OnsetDetector 音符起始点检测 | ✅ | 能量包络 + 频谱通量的 onset 检测 |
| 3.3.2 | BPMTracker 实时速度估算 | ✅ | 基于 onset 间隔的自适应 BPM 跟踪 |

### 3.4 音源分离

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 3.4.1 | EchoCanceller 回声消除 | ✅ | NLMS 自适应滤波器，分离扬声器伴奏与麦克风乐器声 |

---

## 阶段四：乐谱引擎（Score Engine）

### 4.1 乐谱渲染

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 4.1.1 | OSMD 集成与 ScoreViewer 组件 | ✅ | OpenSheetMusicDisplay 初始化、MusicXML 渲染五线谱 |
| 4.1.2 | 乐谱缩放与翻页 | ✅ | 双指缩放、滚动翻页、小节编号显示 |
| 4.1.3 | 演奏标记渲染 | ✅ | 指法编号、弓法标记（上弓/下弓）、踏板标记 |
| 4.1.4 | ScoreAnnotation 错误标注层 | ✅ | 覆盖层渲染：正确(绿)、错误(红)、漏弹(灰)标记 |

### 4.2 乐谱跟随

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 4.2.1 | ScoreFollower DTW 算法 | ✅ | 基于 chroma 特征的在线 DTW 实时乐谱跟随 |
| 4.2.2 | NoteAligner 音符对齐 | ✅ | 将检测到的音符与乐谱音符匹配对齐 |
| 4.2.3 | ScoreCursor 光标跟随 | ✅ | 当前演奏位置高亮、乐谱自动滚动跟随 |
| 4.2.4 | 实时错误提示 | ✅ | 浮动气泡提示（偏高/偏低/过快/过慢）+ 颜色标注 |

---

## 阶段五：MIDI 引擎与节拍器

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 5.1 | Tone.js 集成与 MidiPlayer | ✅ | MIDI 文件加载、合成播放、速度控制 |
| 5.2 | MetronomeEngine 节拍器引擎 | ✅ | 可调 BPM（25%-150%）、三种音色（木鱼/电子/静音闪烁） |
| 5.3 | AccompanimentPlayer 伴奏播放 | ✅ | MIDI 伴奏播放、音量独立控制、与节拍器速度同步 |
| 5.4 | Metronome UI 组件 | ✅ | 节拍器开关、BPM 滑块、音色选择、视觉节拍指示 |

---

## 阶段六：评分引擎（Scoring Engine）

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 6.1 | ToleranceConfig 容忍度配置 | ✅ | 三级容忍度（初学/进阶/专业）参数表 |
| 6.2 | SpeedScorer 速度评分 | ✅ | BPM 稳定性方差 + 与标准速度差异评估（0-20 分） |
| 6.3 | RhythmScorer 节奏评分 | ✅ | 音符时值偏差 + 节奏型准确性（0-20 分） |
| 6.4 | IntonationScorer 音准评分 | ✅ | 钢琴键位正误 + 大提琴音分偏差（0-20 分） |
| 6.5 | SmoothnessScorer 流畅度评分 | ✅ | 非预期停顿检测 + 连贯性评估（0-20 分） |
| 6.6 | CompletenessScorer 完整度评分 | ✅ | 演奏音符数/乐谱总音符数 + 跳小节检测（0-20 分） |
| 6.7 | ScoringEngine 评分总调度 | ✅ | 五维评分汇总、诊断式问题分析生成、小节级错误定位 |
| 6.8 | 钢琴多声部评分 | ✅ | 左右手声部独立评分、和弦完整性检测 |

---

## 阶段七：核心页面开发

### 7.1 首页 / 仪表盘 (HomePage)

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 7.1.1 | 学习概览仪表盘 | ✅ | 练习时长统计、评分汇总、学习进度曲线图 |
| 7.1.2 | 最近练习记录列表 | ✅ | 时间倒序、曲目名/乐器/时间/评分、点击跳转报告 |
| 7.1.3 | 每周练习目标进度 | ✅ | 目标设定（天数/时长）、进度条、达成激励反馈 |
| 7.1.4 | 未完成练习入口 | ✅ | 中断保存的练习显示"未完成"状态，可继续录制 |

### 7.2 曲库页面 (LibraryPage)

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 7.2.1 | 乐器切换 UI | ✅ | 顶部钢琴/大提琴切换，曲库内容联动更新 |
| 7.2.2 | 曲库浏览与筛选 | ✅ | 分类展示、难度筛选、搜索（曲名/作曲家） |
| 7.2.3 | 曲目卡片组件 | ✅ | 名称、作曲家、难度标签、时长、乐谱缩略图预览 |
| 7.2.4 | 乐谱上传入口 | ✅ | MusicXML 文件选择、上传进度、解析结果展示 |

### 7.3 练习页面 (PracticePage)

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 7.3.1 | 练习前设置面板 | ✅ | 评分模式选择（整曲/单音）、速度设置、节拍器/伴奏开关 |
| 7.3.2 | 乐谱显示区集成 | ✅ | ScoreViewer 嵌入、预览模式、练习模式切换 |
| 7.3.3 | 录制控制面板 (Recorder) | ✅ | 开始/暂停/停止按钮、3 秒倒计时、录制时长显示 |
| 7.3.4 | 实时波形显示 (WaveformDisplay) | ✅ | 音频电平指示、实时波形可视化 |
| 7.3.5 | 视频录制（可选） | ✅ | 摄像头权限请求、视频流录制、与音频同步 |
| 7.3.6 | 音频文件上传入口 | ✅ | 文件选择（WAV/MP3/M4A/FLAC）、上传后触发回溯分析 |
| 7.3.7 | 实时跟随与反馈集成 | ✅ | 音频引擎 + 乐谱引擎 + 评分引擎联动 |
| 7.3.8 | 音效反馈系统 | ✅ | 正确/错误音效播放（默认关闭，可开启） |
| 7.3.9 | 练习中断保存 | ✅ | 自动保存已录制部分、进度位置、下次可继续 |
| 7.3.10 | 停止后确认弹窗 | ✅ | 提交评测/保存稍后继续/重新录制/放弃 |

### 7.4 评测报告页面 (ReportPage)

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 7.4.1 | 五维雷达图 (RadarChart) | ✅ | Recharts 雷达图渲染五维评分，总分显示 |
| 7.4.2 | 诊断式问题分析 (DiagnosticCard) | ✅ | 三步递进：问题定位→原因分析→解决方案，可展开/收起 |
| 7.4.3 | 小节级错误标注 | ✅ | 乐谱中红色边框高亮出错小节，点击查看详情 |
| 7.4.4 | 错误列表与跳转 | ✅ | 按严重程度排序，点击跳转乐谱对应位置 |
| 7.4.5 | 录音回放功能 | ✅ | 回放录音 + 乐谱同步标记、暂停/拖动进度条 |
| 7.4.6 | 标准 MIDI 示范播放 | ✅ | 点击错误小节播放该小节的标准 MIDI 示范 |
| 7.4.7 | 历史最佳对比 | ✅ | 当前评分与历史最佳成绩对比显示 |
| 7.4.8 | 钢琴左右手切换 | ✅ | 切换查看左手/右手/双手评分详情 |

### 7.5 片段练习页面 (SectionPracticePage)

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 7.5.1 | 出错小节选择 | ✅ | 从报告中选择出错小节进入片段练习 |
| 7.5.2 | 片段乐谱显示 | ✅ | 仅显示选中小节的乐谱 |
| 7.5.3 | 片段评分与达标判定 | ✅ | 片段练习独立评分，达标后标记"已纠正" |

### 7.6 调音器页面 (TunerPage)

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 7.6.1 | 调音器核心逻辑 | ✅ | 实时音高检测、与标准音高偏差计算（音分级） |
| 7.6.2 | 智能弦位识别 | ✅ | 自动识别大提琴当前拉奏的弦位（C-G-D-A） |
| 7.6.3 | 基准音高检测 | ✅ | 自动检测乐器调音基准（A4=440Hz/442Hz 等） |
| 7.6.4 | 调音器 UI 组件 (Tuner) | ✅ | 四弦状态独立显示、偏差仪表盘、已调准/偏高/偏低 |

### 7.7 用户中心页面 (ProfilePage)

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 7.7.1 | 个人资料管理 | ✅ | 头像、昵称、学习水平设置（初学/进阶/专业） |
| 7.7.2 | 乐器偏好设置 | ✅ | 默认乐器选择、音效开关、语言切换 |
| 7.7.3 | 历史数据汇总 | ✅ | 累计练习时长、曲目掌握度统计 |
| 7.7.4 | 能力成长图谱 | ✅ | Recharts 趋势图：五维能力历史变化、进步/退步可视化 |
| 7.7.5 | 练习历史时间线 | ✅ | 完整练习记录、按曲目维度查看评分趋势 |

---

## 阶段八：高级功能

### 8.1 成就与激励系统

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 8.1.1 | 成就定义与规则 | ✅ | 定义成就类型：首次满分、连续 7 天练习、曲目通关等 |
| 8.1.2 | 成就检测引擎 | ✅ | 练习完成后自动检测是否触发新成就 |
| 8.1.3 | 成就徽章 UI (AchievementBadge) | ✅ | 徽章展示、达成动画、成就列表页 |
| 8.1.4 | 连续打卡系统 | ✅ | 练习天数连续打卡记录与展示 |

### 8.2 报告分享

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 8.2.1 | 图片分享 (ShareCard) | ✅ | Canvas 生成分享卡片：雷达图 + 总分 + 曲目信息 |
| 8.2.2 | 链接分享 | ✅ | 报告数据编码上传至第三方存储（jsonbin.io），生成可访问链接 |
| 8.2.3 | 分享报告只读页 (ShareReportPage) | ✅ | `/share/:token` 路由，解码并展示完整报告 |

### 8.3 数据导出/导入

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 8.3.1 | JSON 数据导出 | ✅ | 导出练习记录 + 评分数据 + 用户设置，录音可选 |
| 8.3.2 | JSON 数据导入 | ✅ | 导入时自动合并或覆盖（用户可选） |

### 8.4 练习建议系统

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 8.4.1 | 练习建议生成 | ✅ | 根据评测结果推荐：放慢速度、分手练习、分段练习 |
| 8.4.2 | 练习优先级排序 | ✅ | 按薄弱环节严重程度排序建议 |

---

## 阶段九：PWA 与离线支持

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 9.1 | Workbox Service Worker 配置 | ✅ | Cache First（静态资源）、Network First（动态数据） |
| 9.2 | 离线曲库缓存 | ✅ | 首次加载后缓存 MusicXML + MIDI 到本地 |
| 9.3 | PWA Manifest 配置 | ✅ | 应用名称、图标、启动画面、横屏优先 |
| 9.4 | 离线功能验证 | ✅ | 验证核心功能离线可用：乐谱渲染、录制、评分、报告查看 |
| 9.5 | 安装提示 UI | ✅ | PWA 安装引导，添加到桌面 |

---

## 阶段十：响应式适配与优化

### 10.1 响应式布局

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 10.1.1 | 桌面端布局优化 | ✅ | ≥1280px 完整功能，侧边栏 + 内容区 |
| 10.1.2 | 平板端适配 | ✅ | 768-1279px，可折叠侧边栏 |
| 10.1.3 | 手机端只读模式 | ✅ | <768px 竖屏布局，仅支持曲库浏览和报告查看 |

### 10.2 性能优化

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 10.2.1 | 代码分割与懒加载 | ✅ | 按路由分割、WASM 模型异步加载 |
| 10.2.2 | WASM 模型预加载策略 | ✅ | sql.js WASM、Essentia.js WASM、basic-pitch 模型分级加载 |
| 10.2.3 | 乐谱渲染性能优化 | ✅ | OSMD 渲染优化，保证 60fps 滚动 |
| 10.2.4 | 音频处理延迟优化 | ✅ | 确保音频识别延迟 < 100ms |
| 10.2.5 | 首屏加载优化 | ✅ | 目标首屏 JS < 600KB，总资源 < 10MB |

### 10.3 无障碍

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 10.3.1 | 键盘导航支持 | ✅ | 关键操作支持键盘导航 |
| 10.3.2 | 文字描述补充 | ✅ | 评分结果提供文字描述（不仅依赖颜色） |
| 10.3.3 | 最小点击区域 | ✅ | 按钮和控件 ≥ 44x44px |

---

## 阶段十一：测试与部署

| # | 任务 | 状态 | 说明 |
|---|------|------|------|
| 11.1 | 单元测试 | ✅ | 评分引擎、音乐工具函数、数据库操作的单元测试 |
| 11.2 | 音频引擎集成测试 | ✅ | 使用预录制音频样本验证音高检测、节奏检测精度 |
| 11.3 | 乐谱跟随准确性测试 | ✅ | DTW 算法在不同速度、不同乐器下的跟随准确性 |
| 11.4 | 评分一致性测试 | ✅ | 同一录音多次评分结果一致性验证 |
| 11.5 | 跨浏览器兼容性测试 | ✅ | Chrome、Edge、Safari 最新版本验证 |
| 11.6 | 平板端功能测试 | ✅ | iPad 完整功能验证 |
| 11.7 | Cloudflare Pages 部署配置 | ✅ | 构建脚本、环境变量、自定义域名 |
| 11.8 | CI/CD 流水线 | ✅ | GitHub Actions：lint → test → build → deploy |

---

## 任务统计

| 阶段 | 任务数 | 状态 |
|------|--------|------|
| 一、项目基础设施 | 16 | ✅ 全部完成 |
| 二、乐器抽象与曲库 | 10 | ✅ 全部完成 |
| 三、音频引擎 | 8 | ✅ 全部完成 |
| 四、乐谱引擎 | 8 | ✅ 全部完成 |
| 五、MIDI 引擎与节拍器 | 4 | ✅ 全部完成 |
| 六、评分引擎 | 8 | ✅ 全部完成 |
| 七、核心页面开发 | 30 | ✅ 全部完成 |
| 八、高级功能 | 11 | ✅ 全部完成 |
| 九、PWA 与离线支持 | 5 | ✅ 全部完成 |
| 十、响应式适配与优化 | 8 | ✅ 全部完成 |
| 十一、测试与部署 | 8 | ✅ 全部完成 |
| **合计** | **116** | **✅ 全部完成** |

---

## 阶段依赖关系

```
阶段一（基础设施）
  ├──→ 阶段二（乐器抽象与曲库）
  ├──→ 阶段三（音频引擎）
  │       └──→ 阶段四（乐谱引擎）──→ 阶段六（评分引擎）
  ├──→ 阶段五（MIDI 引擎）
  │
  └──→ 阶段七（核心页面）← 依赖阶段二~六的引擎层
          ├──→ 阶段八（高级功能）
          ├──→ 阶段九（PWA 离线）
          └──→ 阶段十（适配与优化）
                  └──→ 阶段十一（测试与部署）
```

> 阶段二~五可并行开发（无相互依赖），阶段六依赖阶段三四的输出，阶段七依赖所有引擎层就绪。
