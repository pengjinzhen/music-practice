# AI 音乐陪练系统 — 产品需求文档

> 工作名称：AI Music Practice（正式名称待定）

## 一、产品概述

### 1.1 产品定位

面向钢琴和大提琴学习者的 AI 智能陪练工具。通过纯前端音频识别与智能评估技术，提供专业级演奏评测、实时乐谱跟随、多声部识别和个性化练习指导。以学生自主练习为核心场景，支持轻量级师生协同（教师通过分享报告查看学生数据）。

### 1.2 目标用户

- 钢琴初学者至进阶学习者
- 大提琴初学者至进阶学习者
- 音乐教师（通过分享链接/图片查看学生练习报告，无需独立教师端）

### 1.3 支持乐器

- 钢琴（Piano）
- 大提琴（Cello）
- 架构预留乐器抽象层，未来可扩展至小提琴、长笛、吉他等

### 1.4 使用环境

- Web 端应用（横屏优先，支持 PWA 离线使用）
- 桌面端和平板端完整功能支持
- 手机端只读模式（浏览曲库、查看报告，不支持录制练习）
- 需要麦克风权限（音频采集）
- 可选摄像头权限（视频录制）

### 1.5 国际化

- 双语支持：英文（默认）/ 中文
- 跟随浏览器语言自动检测，用户可手动切换
- 曲库兼顾国内外曲目

### 1.6 技术约束

- 纯前端架构（Web Audio API + WASM），零后端服务器依赖
- 音频分析、评分、乐谱渲染全部在浏览器端完成
- 静态托管部署（Cloudflare Pages / Vercel / GitHub Pages）
- 前端技术栈：React + TypeScript

---

## 二、功能模块

### 2.1 首页 / 个人中心

#### 2.1.1 学习概览仪表盘

- 显示近期练习时长统计（分钟数）
- 显示近期获得积分/评分汇总
- 显示学习进度曲线图
- 每周练习目标完成进度条

#### 2.1.2 最近练习记录

- 按时间倒序展示最近练习的曲目列表
- 每条记录显示：曲目名称、乐器类型、练习时间、综合评分
- 点击记录可跳转至对应的评测报告详情
- 支持查看中断保存的未完成练习，可继续录制

#### 2.1.3 用户中心

- 个人资料管理（头像、昵称、学习水平）
- 学习水平设置（初学、进阶、专业）— 影响评分容忍度
- 乐器偏好设置
- 历史数据汇总统计
- 数据导出/导入功能（JSON 格式，用于备份和设备迁移）
- 语言切换（English / 中文）

#### 2.1.4 练习目标跟踪

- 用户可设定每周练习目标（练习天数、练习时长）
- 首页显示本周目标完成进度
- 目标达成时给予视觉激励反馈

---

### 2.2 曲目选择

#### 2.2.1 乐器切换

- 顶部或侧边提供钢琴/大提琴切换入口
- 切换后曲库内容随之更新

#### 2.2.2 曲库浏览

- 按分类展示曲目（练习曲、古典、考级曲目等）
- 按难度等级筛选（初级、中级、高级）— 难度由算法自动计算
- 搜索功能：支持按曲目名称、作曲家搜索
- 每首曲目显示：名称、作曲家、难度、时长、乐谱预览缩略图

#### 2.2.3 曲库内容（初始曲库）

仅使用公版曲目（作曲家去世超过 70 年），避免版权问题。

**钢琴曲库（不少于 20 首）：**
- 初级：《小星星变奏曲》《欢乐颂》《致爱丽丝》《小步舞曲》等
- 中级：《土耳其进行曲》《卡农》《G大调小步舞曲》等
- 高级：《月光奏鸣曲》《悲怆奏鸣曲》《革命练习曲》等

**大提琴曲库（不少于 15 首）：**
- 初级：《小星星》《欢乐颂》大提琴版、基础音阶练习等
- 中级：巴赫《大提琴组曲第一号前奏曲 BWV 1007》、圣桑《天鹅》等
- 高级：埃尔加《大提琴协奏曲》、德沃夏克《大提琴协奏曲》选段等

#### 2.2.4 用户自定义乐谱

- 支持用户上传 MusicXML 格式乐谱
- 上传后系统自动计算难度等级（基于音符密度、音域范围、节奏复杂度等特征）
- 用户上传的乐谱存储在本地 IndexedDB 中
- 适用场景：老师布置的特定练习曲、系统曲库未收录的曲目

#### 2.2.5 乐谱格式

- 支持 MusicXML 格式乐谱
- 系统内置标准乐谱，作为评测对比基准

---

### 2.3 练习界面（核心页面）

#### 2.3.1 乐谱显示区

- 可视化渲染标准五线谱（基于 MusicXML 解析）
- 支持乐谱缩放、翻页
- 当前演奏位置高亮指示（光标跟随）
- 错误音符标红标注
- 小节编号显示
- 演奏标记显示：
  - 指法编号（钢琴 1-5，大提琴 0-4）
  - 弓法标记（大提琴：上弓/下弓）
  - 踏板标记（钢琴）
  - 以上标记从 MusicXML 中解析，如乐谱包含则显示

#### 2.3.2 评分模式切换

提供两种评分模式，用户可在练习前选择：

**整曲模式（Musical Piece）：**
- 评估整首曲目的综合表现
- 侧重整体艺术表现力、风格把握、宏观连贯性
- 演奏完毕后生成完整评测报告

**单音模式（Single Note）：**
- 逐音符精确检测
- 侧重基础巩固，检测每个音符的准确性
- 实时反馈每个音符的正误

#### 2.3.3 演奏输入方式

**方式一：现场演奏录制**
- 点击"开始录制"按钮，通过麦克风实时采集演奏音频
- 可选开启摄像头同步录制视频（用于姿态复盘）
- 录制过程中显示实时音频波形
- 支持暂停/继续/停止操作
- 录制完成后自动提交评测
- 中断保存：弹到一半停止时，自动保存已录制部分，下次可从中断处继续，或对已录制部分生成部分报告

**方式二：音频文件上传**
- 支持上传预录制的音频文件
- 支持格式：WAV、MP3、M4A、FLAC
- 上传后进行同等维度的回溯分析

#### 2.3.4 节拍器与伴奏

**内置节拍器：**
- 可开关的节拍器功能
- 支持调节 BPM（可设为原曲速度的 25%-150%）
- 节拍器音色可选（木鱼、电子、静音闪烁）

**伴奏播放：**
- 支持播放标准 MIDI 伴奏/示范音频
- 伴奏从扬声器播放，系统通过算法分离伴奏声与乐器声
- 伴奏速度与节拍器同步
- 可单独调节伴奏音量

#### 2.3.5 速度控制

- 自适应速度检测：系统自动检测学生的实际演奏速度
- 评分基于学生的实际演奏速度评估其他维度（节奏稳定性、音准等）
- 速度维度单独评估实际速度与标准速度的差异
- 用户也可手动设定目标练习速度（如原速的 50%/75%）

#### 2.3.6 乐谱弹奏跟随

- 实时音频识别，将演奏音符与乐谱音符进行匹配
- 当前演奏位置在乐谱上实时高亮跟随（光标/高亮条随演奏进度移动）
- 识别到正确音符时，对应乐谱音符标记为绿色（已通过）
- 识别到错误音符时，对应乐谱音符标记为红色，并给出简短提示
- 漏弹的音符标记为灰色
- 跟随算法需容忍合理的速度波动，不因微小时值偏差丢失跟踪
- 乐谱自动滚动跟随演奏进度

#### 2.3.7 多声部识别（钢琴）

- 支持钢琴双手演奏的完整多声部识别
- 左右手声部独立识别与评分
- 和弦识别：检测某一时刻发出的音符组合是否正确
- 报告中可分别查看左手和右手的评分详情

#### 2.3.8 实时错误提示

**视觉反馈（始终启用）：**
- 音高错误：乐谱音符标红 + 浮动气泡提示"偏高/偏低"及偏差量（音分）
- 节奏错误：提示"过快"或"过慢"
- 漏音提示：提示跳过的音符
- 提示方式：乐谱上方浮动气泡 + 颜色标注

**音效反馈（可选，默认关闭）：**
- 弹对时发出轻微确认音效
- 弹错时发出提示音效
- 音效从扬声器播放，与伴奏共用音源分离算法
- 用户可在设置中开启/关闭，开启时提示可能影响识别精度

---

### 2.4 大提琴调音器

#### 2.4.1 智能调音功能

- 内置专用调音器，练习前可快速调音
- 智能识别当前拉奏的弦位（C-G-D-A），自动判断是哪根弦
- 显示当前音高与标准音高的偏差（音分级精度）
- 每根弦的调音状态独立显示（已调准 / 偏高 / 偏低）

#### 2.4.2 基准音高

- 系统自动检测乐器的实际调音基准并适配
- 支持常见基准音高（A4=440Hz、442Hz 等）
- 检测结果显示在调音器界面，用户可确认或手动修正

---

### 2.5 演奏评测报告

#### 2.5.1 五维能力评分模型

演奏结束后，系统从以下五个维度进行量化评分（每项 0-20 分，总分 100 分）：

| 维度 | 说明 |
|------|------|
| 速度（Speed） | 演奏速度的稳定性及与标准速度的契合度 |
| 节奏（Rhythm） | 音符时值长短、节奏型的准确性 |
| 音准（Intonation） | 音高精准度，频率偏差分析（专业级精度） |
| 流畅度（Smoothness） | 演奏连贯性，是否有不必要的断句、停顿 |
| 完整度（Completeness） | 演奏完整性，是否存在漏音、跳小节 |

- 以雷达图/五边形图可视化展示五维评分
- 显示总分及各维度得分
- 与历史最佳成绩对比
- 评分容忍度根据用户学习水平自动调整（初学者宽松，专业者严格）

#### 2.5.2 诊断式问题分析

针对表现薄弱的环节，提供三步递进式指导：

1. **问题定位（Problem）**：明确失误的具体位置（第几小节、第几拍）
2. **原因分析（Cause Analysis）**：基于演奏数据分析潜在技术原因
3. **解决方案（Solution）**：提供专业练习建议与针对性纠错方案

- 每个问题项可展开/收起
- 问题按严重程度排序

#### 2.5.3 小节级错误标注

- 在可视化乐谱中精准标注出错小节
- 错误小节用红色边框或背景高亮
- 点击错误小节可查看该小节的详细错误信息
- 支持播放该小节的标准 MIDI 示范

#### 2.5.4 录音回放

- 支持回放自己的演奏录音
- 回放时乐谱同步显示当时的正确/错误标记（光标跟随回放进度）
- 可暂停、拖动进度条到任意位置
- 回放时可同时查看对应时刻的评分详情

#### 2.5.5 报告分享

**图片分享：**
- 生成包含评分雷达图、总分、曲目信息的分享卡片图片
- 可保存到本地或分享到社交平台

**链接分享：**
- 报告数据通过第三方存储服务（如 GitHub Gist / Pastebin）生成可访问链接
- 教师或他人打开链接可查看完整报告
- 链接有效期可设定（如 30 天）

---

### 2.6 闭环纠错与强化训练

#### 2.6.1 定向片段练习

- 从评测报告中选择出错小节，进入片段练习模式
- 仅显示选中小节的乐谱，进行针对性重练
- 片段练习同样进行评分，直至达标
- 达标后自动标记该小节为"已纠正"

#### 2.6.2 练习建议

- 根据评测结果推荐针对性练习内容
- 建议包括：放慢速度练习、分手练习（钢琴）、分段练习
- 提供练习优先级排序（先攻克最薄弱环节）

---

### 2.7 学习进度与数据

#### 2.7.1 练习历史

- 完整的练习记录时间线
- 每次练习的评分详情可回溯查看
- 按曲目维度查看历史评分趋势

#### 2.7.2 能力成长图谱

- 五维能力的历史变化趋势图
- 各维度的进步/退步可视化
- 累计练习时长统计
- 曲目掌握度统计（已掌握/练习中/未开始）

#### 2.7.3 成就与激励

- 练习天数连续打卡
- 里程碑成就徽章（如：首次满分、连续7天练习等）
- 曲目通关进度

---

## 三、页面结构与导航

### 3.1 页面清单

| 页面 | 路由 | 说明 |
|------|------|------|
| 首页 | `/` | 学习概览、最近练习、目标跟踪、快捷入口 |
| 曲库 | `/library` | 曲目浏览、搜索、乐器筛选 |
| 练习页 | `/practice` | 乐谱显示、录制、实时跟随、节拍器 |
| 评测报告 | `/report/:id` | 五维评分、问题分析、错误标注、录音回放 |
| 片段练习 | `/practice/section` | 出错小节定向练习 |
| 调音器 | `/tuner` | 大提琴调音（也可作为练习页内嵌组件） |
| 用户中心 | `/profile` | 个人资料、设置、历史数据、数据导出导入 |
| 分享报告 | `/share/:token` | 外部访问的只读报告页 |

### 3.2 布局规范

- 整体采用横屏布局（landscape），适配桌面和平板
- 左侧固定侧边栏导航
- 练习页面全屏沉浸式，乐谱区域最大化
- 手机端自适应为竖屏只读布局
- 支持 PWA 安装，可添加到桌面

---

## 四、交互细节

### 4.1 练习流程

```
选择乐器 → [大提琴可选调音] → 选择曲目 → 选择评分模式（整曲/单音）
→ 设置速度（原速/自定义/自适应）→ 开关节拍器/伴奏
→ 选择输入方式（现场录制/上传音频）
→ 3秒倒计时 → 开始演奏（乐谱跟随 + 实时提示）
→ 演奏结束/中断 → 生成评测报告
→ 查看报告 → 回放录音 → 选择薄弱小节重练 → 再次评测
```

### 4.2 录制交互

- 录制前：3 秒倒计时准备
- 录制中：顶部显示录制时长、音频电平指示
- 可随时暂停/停止
- 停止后弹出确认：提交评测 / 保存并稍后继续 / 重新录制 / 放弃
- 中断保存的录制在首页"最近练习"中显示为"未完成"状态

### 4.3 乐谱交互

- 练习前可预览完整乐谱，支持滚动浏览
- 练习中乐谱自动滚动跟随演奏进度
- 支持手动拖动乐谱查看（暂停跟随）
- 双指缩放调整乐谱大小
- 点击任意小节可从该位置开始练习

### 4.4 报告交互

- 报告页顶部显示总分和五维雷达图
- 下方分区展示各维度详细分析
- 错误列表支持点击跳转到乐谱对应位置
- 录音回放按钮，回放时乐谱同步标记
- 分享按钮（图片 / 链接）
- 钢琴报告可切换查看左手/右手/双手评分

---

## 五、智能评分规则

### 5.1 评分容忍度（按学习水平自动调整）

| 水平 | 音准容忍 | 节奏容忍 | 速度容忍 |
|------|----------|----------|----------|
| 初学 | ±50 音分 | ±30% 时值偏差 | ±40% BPM 偏差 |
| 进阶 | ±25 音分 | ±15% 时值偏差 | ±20% BPM 偏差 |
| 专业 | ±10 音分 | ±8% 时值偏差 | ±10% BPM 偏差 |

### 5.2 速度评分（Speed，0-20 分）

- 自适应速度检测：系统自动识别学生的实际演奏速度
- 评估演奏速度的稳定性（BPM 方差）
- 评估实际速度与标准速度的差异（作为参考，非主要扣分项）
- 如用户设定了目标速度，则基于目标速度评估

### 5.3 节奏评分（Rhythm，0-20 分）

- 检测每个音符的实际时值与标准时值的偏差
- 评估节奏型的准确性（附点、切分、三连音等）
- 计算节奏正确率 = 正确节奏音符数 / 总音符数

### 5.4 音准评分（Intonation，0-20 分）

- 专业级精度检测
- 钢琴：检测是否弹对键位（正确/错误二值判断）+ 和弦完整性
- 大提琴：检测音高的连续偏差（音分级精度），给出具体偏差值
- 计算音准正确率

### 5.5 流畅度评分（Smoothness，0-20 分）

- 检测演奏中的非预期停顿（超过合理时值的空白）
- 评估乐句间的连贯性
- 检测是否有重复弹奏（犹豫重来）
- 停顿次数越少、连贯性越好，得分越高

### 5.6 完整度评分（Completeness，0-20 分）

- 统计实际演奏的音符数与乐谱总音符数的比例
- 检测是否有跳过的小节
- 中断保存的练习按已演奏部分评估完整度

---

## 六、音频处理核心需求

### 6.1 音高检测

- 实时基频检测（延迟 < 100ms）
- 钢琴：多音同时检测（和弦识别），支持完整多声部
- 大提琴：连续音高追踪，音分级精度
- 支持的音域：A0 (27.5Hz) ~ C8 (4186Hz)

### 6.2 多声部识别（钢琴）

- 左右手声部独立识别
- 和弦中各音符的分离检测
- 基于音域分布和乐谱声部信息辅助左右手判断

### 6.3 音源分离

- 分离扬声器播放的伴奏/节拍器/音效与麦克风采集的乐器声
- 利用已知的伴奏音频信号进行自适应消除
- 需处理房间混响和延迟带来的信号差异

### 6.4 节奏检测

- 音符起始点（onset）精确检测
- 音符时值计算
- BPM 实时估算与跟踪

### 6.5 环境适应

- 基本环境噪声过滤
- 自动增益控制
- 基准音高自动检测与适配

---

## 七、数据存储需求

### 7.1 用户数据

- 用户基本信息（本地存储，数据结构预留 userId 字段，方便后续迁移云端）
- 学习偏好设置（水平、乐器、语言、音效开关等）
- 练习目标设定

### 7.2 练习数据

- 每次练习记录：曲目、时间、时长、评分详情、录音文件
- 五维评分历史
- 错误详情记录（小节、错误类型、偏差值）
- 中断保存的未完成练习（含已录制音频和进度位置）

### 7.3 曲库数据

- 曲目元信息（名称、作曲家、难度、乐器类型）
- MusicXML 乐谱文件
- MIDI 文件（用于示范播放和伴奏）
- 用户上传的自定义乐谱

### 7.4 存储方式

- 主存储：IndexedDB（练习记录、录音文件、用户上传乐谱）
- 轻量配置：LocalStorage（用户设置、偏好）
- 曲库资源：随应用打包，PWA Service Worker 缓存
- 数据结构预留 userId 字段，方便后续接入账号体系和云端同步

### 7.5 数据导出/导入

- 导出格式：JSON（练习记录 + 评分数据 + 用户设置）
- 录音文件可选导出（文件较大，默认不包含）
- 导入时自动合并或覆盖（用户可选）
- 用于设备迁移和数据备份

---

## 八、非功能性需求

### 8.1 性能要求

- 音频识别延迟 < 100ms（保证实时跟随体验）
- 乐谱渲染流畅，滚动无卡顿（60fps）
- 评测报告生成时间 < 5 秒
- 音源分离处理不影响实时跟随性能

### 8.2 兼容性

- 支持 Chrome、Edge、Safari 最新版本
- 桌面端和平板端（iPad）完整功能
- 手机端只读模式（曲库浏览、报告查看）
- 横屏优先，手机端竖屏适配

### 8.3 离线能力

- 核心功能离线可用：乐谱渲染、录制、评分、报告查看
- 曲库首次加载后缓存到本地，离线可用
- 需要联网的功能：报告链接分享、用户上传乐谱的在线来源
- PWA Service Worker 策略：Cache First for assets, Network First for API

### 8.4 音频环境

- 建议用户在安静环境下使用
- 系统具备基本的环境噪声过滤能力
- 麦克风建议放置在距乐器 30-100cm 处
- 伴奏播放时建议适当降低扬声器音量以提高识别精度

### 8.5 无障碍

- 关键操作支持键盘导航
- 评分结果提供文字描述（不仅依赖颜色）
- 按钮和控件符合最小点击区域要求（44x44px）

---

## 九、MVP 范围界定

基于采访确认，MVP 范围包含全部核心功能：

### MVP 完整功能清单：

1. 首页学习概览与最近练习记录
2. 练习目标跟踪（每周目标设定与进度）
3. 钢琴和大提琴曲库（各 10+ 首公版曲目）
4. 用户自定义乐谱上传（MusicXML）
5. 乐谱可视化渲染（五线谱 + 指法/弓法/踏板标记）
6. 现场录制 + 音频文件上传
7. 整曲模式 + 单音模式评分
8. 五维评分报告（雷达图 + 诊断分析 + 小节级错误标注）
9. 乐谱弹奏跟随（实时光标跟随）
10. 钢琴多声部识别（左右手独立识别与评分）
11. 大提琴专业级音准检测（音分级精度）
12. 内置节拍器 + 伴奏播放
13. 扬声器伴奏音源分离
14. 视觉 + 音效错误反馈
15. 大提琴智能调音器（弦位识别 + 基准音自动检测）
16. 自适应速度检测与评分
17. 评分容忍度按学习水平自动调整
18. 录音回放 + 乐谱同步标记
19. 练习中断保存与继续
20. 定向片段练习（出错小节重练）
21. 能力成长图谱与趋势分析
22. 成就系统与练习激励
23. 报告分享（图片 + 第三方存储链接）
24. 数据导出/导入
25. 双语支持（EN/ZH）
26. PWA 离线支持
27. 曲目难度自动计算

---

## 十、术语表

| 术语 | 说明 |
|------|------|
| BPM | Beats Per Minute，每分钟节拍数 |
| MusicXML | 标准化的乐谱数字格式 |
| MIDI | Musical Instrument Digital Interface，乐器数字接口 |
| 音分（Cent） | 音高偏差单位，100 音分 = 1 个半音 |
| 五维评分 | Speed / Rhythm / Intonation / Smoothness / Completeness |
| 整曲模式 | Musical Piece 模式，评估整体演奏表现 |
| 单音模式 | Single Note 模式，逐音符精确检测 |
| PWA | Progressive Web App，渐进式 Web 应用 |
| WASM | WebAssembly，浏览器端高性能计算 |
| Onset | 音符起始点，音频中音符开始发声的时刻 |
| 音源分离 | 从混合音频中分离出不同声源的技术 |
